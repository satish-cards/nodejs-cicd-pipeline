# GitHub Actions CI Workflow Documentation

## Overview

The CI (Continuous Integration) workflow automatically builds, tests, and validates the Node.js application on every push and pull request. This ensures code quality and prevents broken code from being merged.

## Workflow File

**Location**: `.github/workflows/ci.yml`

## Trigger Events

The workflow runs automatically on:
- **Push**: Any branch push
- **Pull Request**: Any pull request to any branch

```yaml
on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
```

## Jobs

### 1. Install Dependencies

**Purpose**: Install and cache npm dependencies

**Steps**:
1. Checkout code
2. Setup Node.js 18
3. Run `npm ci` to install dependencies with clean slate
4. Cache `node_modules` for subsequent jobs

**Why npm ci?**
- Faster than `npm install`
- Uses exact versions from `package-lock.json`
- Ensures reproducible builds
- Verifies package integrity

### 2. Lint Code

**Purpose**: Enforce code quality and style standards

**Steps**:
1. Checkout code
2. Setup Node.js 18
3. Restore cached dependencies
4. Run ESLint: `npm run lint`

**What it checks**:
- Code style consistency
- Common JavaScript errors
- Best practices violations
- Unused variables

**Fails if**: Any linting errors are found

### 3. Run Tests with Coverage

**Purpose**: Verify application functionality and track test coverage

**Steps**:
1. Checkout code
2. Setup Node.js 18
3. Restore cached dependencies
4. Run Jest tests: `npm test`
5. Upload coverage reports as artifacts

**What it tests**:
- Unit tests for all routes
- Middleware functionality
- Error handling
- Integration tests

**Coverage reports**: Available as downloadable artifacts in GitHub Actions UI

**Fails if**: Any test fails

### 4. Build Docker Image

**Purpose**: Verify Docker image builds successfully and runs correctly

**Steps**:
1. Checkout code
2. Setup Docker Buildx (advanced build features)
3. Build Docker image tagged with commit SHA
4. Test the built image:
   - Start container
   - Wait 5 seconds for startup
   - Curl health endpoint
   - Stop and remove container

**Image tagging**: `nodejs-cicd-pipeline:${GITHUB_SHA}`

**Caching**: Uses GitHub Actions cache for Docker layers

**Fails if**: 
- Docker build fails
- Container doesn't start
- Health check fails

### 5. CI Status Check

**Purpose**: Aggregate status of all jobs

**Steps**:
1. Check results of lint, test, and build jobs
2. Fail if any job failed
3. Pass if all jobs succeeded

**Why needed?**: Provides single status check for branch protection rules

## Job Dependencies

```
install
  ├── lint
  └── test
       └── build
            └── status
```

- `lint` and `test` run in parallel after `install`
- `build` runs only after both `lint` and `test` succeed
- `status` runs after all jobs complete (even if some fail)

## Caching Strategy

**Node modules caching**:
- Key: `${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}`
- Invalidated when: `package-lock.json` changes
- Benefit: Faster dependency installation

**Docker layer caching**:
- Type: GitHub Actions cache
- Benefit: Faster Docker builds

## Status Checks

The following status checks are reported to GitHub:
1. ✅ Install Dependencies
2. ✅ Lint Code
3. ✅ Run Tests with Coverage
4. ✅ Build Docker Image
5. ✅ CI Status Check

## Branch Protection Integration

To require CI to pass before merging:

1. Go to repository Settings → Branches
2. Add branch protection rule for `main`
3. Enable "Require status checks to pass before merging"
4. Select required checks:
   - Lint Code
   - Run Tests with Coverage
   - Build Docker Image
   - CI Status Check

See [Branch Protection Setup Guide](branch-protection-setup.md) for detailed instructions.

## Artifacts

**Coverage Reports**:
- Generated by: Test job
- Location: `coverage/` directory
- Available for: 90 days (GitHub default)
- Download from: Actions run summary page

## Performance

**Typical execution times**:
- Install: ~30 seconds (with cache)
- Lint: ~10 seconds
- Test: ~15 seconds
- Build: ~60 seconds (with cache)
- **Total**: ~2 minutes

## Troubleshooting

### Workflow Not Triggering

**Problem**: Workflow doesn't run on push

**Solutions**:
1. Check workflow file is in `.github/workflows/` directory
2. Verify YAML syntax is valid
3. Ensure branch name matches trigger pattern
4. Check GitHub Actions is enabled in repository settings

### Lint Job Failing

**Problem**: ESLint errors prevent merge

**Solutions**:
1. Run `npm run lint` locally to see errors
2. Fix linting errors in code
3. Or run `npm run lint -- --fix` to auto-fix some issues
4. Commit and push fixes

### Test Job Failing

**Problem**: Tests fail in CI but pass locally

**Solutions**:
1. Check for environment-specific issues
2. Verify all dependencies are in `package.json`
3. Look for timing issues in tests
4. Check test logs in GitHub Actions UI
5. Run tests with same Node version (18) locally

### Build Job Failing

**Problem**: Docker build fails or health check times out

**Solutions**:
1. Test Docker build locally: `docker build -t test .`
2. Check Dockerfile syntax
3. Verify all required files are included (not in `.dockerignore`)
4. Increase health check timeout if needed
5. Check application logs: `docker logs test-container`

### Cache Issues

**Problem**: Builds are slow or using stale dependencies

**Solutions**:
1. Clear cache: Go to Actions → Caches → Delete cache
2. Update `package-lock.json`: `npm install`
3. Verify cache key in workflow file

## Best Practices

1. **Run CI locally before pushing**
   ```bash
   npm run lint
   npm test
   docker build -t test .
   ```

2. **Keep CI fast**
   - Use caching effectively
   - Run only necessary tests
   - Parallelize independent jobs

3. **Fix broken builds immediately**
   - Don't push more changes on top of failures
   - Investigate and fix root cause
   - Consider reverting if fix takes too long

4. **Monitor CI performance**
   - Track execution times
   - Optimize slow jobs
   - Update dependencies regularly

5. **Use meaningful commit messages**
   - CI logs reference commit messages
   - Helps debugging failed builds
   - Improves team communication

## Related Documentation

- [CI/CD Overview](ci-cd-overview.md)
- [Branch Protection Setup](branch-protection-setup.md)
- [Deployment Guide](deployment-guide.md)
- [Troubleshooting Guide](../README.md#troubleshooting)

## Workflow Diagram

```
┌─────────────────────────────────────────────────────────┐
│                    Push / Pull Request                   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │  Install Dependencies │
         └───────────┬───────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
    ┌────────┐            ┌──────────┐
    │  Lint  │            │   Test   │
    └────┬───┘            └─────┬────┘
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
            ┌───────────────┐
            │ Build Docker  │
            └───────┬───────┘
                    │
                    ▼
            ┌───────────────┐
            │ Status Check  │
            └───────────────┘
                    │
                    ▼
            ┌───────────────┐
            │ ✅ CI Passed  │
            └───────────────┘
```

## Environment Variables

The CI workflow uses the following GitHub-provided environment variables:

- `GITHUB_SHA`: Commit SHA for image tagging
- `GITHUB_REF`: Branch or tag reference
- `GITHUB_REPOSITORY`: Repository name
- `RUNNER_OS`: Operating system (ubuntu-latest)

No custom secrets are required for the CI workflow.

## Future Enhancements

Potential improvements to consider:

1. **Parallel test execution**: Split tests across multiple runners
2. **Matrix builds**: Test on multiple Node.js versions
3. **Security scanning**: Add dependency vulnerability checks
4. **Code quality metrics**: Integrate SonarQube or similar
5. **Slack notifications**: Alert team on failures
6. **Performance benchmarks**: Track build and test times
7. **Automatic dependency updates**: Dependabot integration

## Compliance

This CI workflow satisfies the following requirements:

- **4.1**: Automatic trigger on code push ✅
- **4.2**: Dependency installation with integrity verification ✅
- **4.3**: Automated test execution with failure handling ✅
- **4.4**: Code linting and style checks ✅
- **4.5**: Docker image building with commit SHA tagging ✅
- **10.4**: CI runs on pull requests before merge ✅
- **11.4**: Uses GitHub Actions as CI/CD platform ✅
